<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Legit Heartbeat Image Scanner</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
  font-family:Arial, sans-serif;
  background:#f4f6f8;
  padding:20px;
}
.container{
  max-width:650px;
  margin:auto;
  background:#fff;
  padding:20px;
  border-radius:12px;
  box-shadow:0 4px 12px rgba(0,0,0,.15);
}
h2{text-align:center;}
input, button{
  width:100%;
  padding:10px;
  margin-top:10px;
}
button{
  background:#2563eb;
  color:#fff;
  border:none;
  border-radius:8px;
  cursor:pointer;
}
button:hover{background:#1e40af;}
canvas{
  width:100%;
  margin-top:10px;
  border:1px solid #ddd;
}
.result{
  margin-top:15px;
  text-align:center;
  font-weight:bold;
}
.valid{color:green;}
.invalid{color:red;}
</style>
</head>

<body>
<div class="container">
  <h2>ü´Ä Legit Heartbeat Image Scanner</h2>

  <input type="file" id="upload" accept="image/*">
  <canvas id="canvas"></canvas>

  <button onclick="analyze()">Analyze Image</button>

  <div class="result" id="result"></div>
</div>

<script>
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
let img = new Image();

// LOAD IMAGE
document.getElementById("upload").addEventListener("change", e=>{
  const file = e.target.files[0];
  if(!file) return;

  img.src = URL.createObjectURL(file);
  img.onload = ()=>{
    canvas.width = img.width;
    canvas.height = img.height;
    ctx.drawImage(img,0,0);
  }
});

// MAIN ANALYSIS
function analyze(){
  const imageData = ctx.getImageData(0,0,canvas.width,canvas.height);
  const data = imageData.data;

  let waveform = [];

  // Extract waveform column-by-column
  for(let x=0; x<canvas.width; x+=4){
    let sumY = 0, count = 0;

    for(let y=0; y<canvas.height; y++){
      let i = (y * canvas.width + x) * 4;
      let brightness = (data[i]+data[i+1]+data[i+2]) / 3;

      if(brightness > 200){
        sumY += y;
        count++;
      }
    }

    if(count > 5){
      waveform.push(canvas.height - (sumY / count));
    }
  }

  // Reject if signal too small
  if(waveform.length < 30){
    show("‚ùå Not a heartbeat image", false);
    return;
  }

  // PEAK DETECTION
  let peaks = [];
  for(let i=2;i<waveform.length-2;i++){
    if(
      waveform[i] > waveform[i-1] &&
      waveform[i] > waveform[i+1] &&
      waveform[i] - waveform[i-2] > 20
    ){
      peaks.push(i);
    }
  }

  // RULE 1: Minimum peaks
  if(peaks.length < 5){
    show("‚ùå No valid heartbeat detected", false);
    return;
  }

  // INTERVAL CONSISTENCY
  let intervals = [];
  for(let i=1;i<peaks.length;i++){
    intervals.push(peaks[i] - peaks[i-1]);
  }

  let avg = intervals.reduce((a,b)=>a+b)/intervals.length;
  let variance = intervals.reduce((a,b)=>a+Math.abs(b-avg),0)/intervals.length;

  // RULE 2: Regular rhythm
  if(variance > avg * 0.4){
    show("‚ùå Irregular signal (not heartbeat)", false);
    return;
  }

  // BPM ESTIMATION
  let bpm = Math.round(600 / avg);

  // RULE 3: Human BPM only
  if(bpm < 40 || bpm > 180){
    show("‚ùå BPM not human-like", false);
    return;
  }

  // ‚úÖ PASSED ALL CHECKS
  show("‚úÖ Valid Heartbeat Detected | BPM: " + bpm, true);
  playHeartbeat(bpm);
}

// RESULT DISPLAY
function show(msg, valid){
  const r = document.getElementById("result");
  r.textContent = msg;
  r.className = "result " + (valid ? "valid" : "invalid");
}

// HEARTBEAT SOUND
function playHeartbeat(bpm){
  const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  let interval = 60000 / bpm;

  let beat = setInterval(()=>{
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();

    osc.type = "sine";
    osc.frequency.value = 120;
    gain.gain.value = 0.5;

    osc.connect(gain);
    gain.connect(audioCtx.destination);

    osc.start();
    osc.stop(audioCtx.currentTime + 0.12);
  }, interval);

  setTimeout(()=>clearInterval(beat), 5000);
}
</script>
</body>
</html>
