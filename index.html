<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Heartbeat Scan to Sound</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
  font-family:Arial,sans-serif;
  background:#f4f6f8;
  padding:20px;
}
.container{
  max-width:600px;
  margin:auto;
  background:#fff;
  padding:20px;
  border-radius:12px;
  box-shadow:0 4px 12px rgba(0,0,0,.15);
}
h2{text-align:center;}
canvas{
  width:100%;
  border:1px solid #ddd;
  margin-top:10px;
}
button{
  margin-top:10px;
  padding:10px;
  width:100%;
  background:#2563eb;
  color:#fff;
  border:none;
  border-radius:8px;
  cursor:pointer;
}
button:hover{background:#1e40af;}
.result{
  margin-top:15px;
  font-weight:bold;
  text-align:center;
}
</style>
</head>

<body>
<div class="container">
  <h2>ðŸ«€ Heartbeat Scan to Sound</h2>

  <input type="file" accept="image/*" id="upload">

  <canvas id="canvas"></canvas>

  <button onclick="analyze()">Analyze & Play Sound</button>

  <div class="result" id="result"></div>
</div>

<script>
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
let img = new Image();

document.getElementById("upload").addEventListener("change", e => {
  const file = e.target.files[0];
  if(!file) return;

  img.src = URL.createObjectURL(file);
  img.onload = () => {
    canvas.width = img.width;
    canvas.height = img.height;
    ctx.drawImage(img,0,0);
  };
});

function analyze(){
  const imageData = ctx.getImageData(0,0,canvas.width,canvas.height);
  const data = imageData.data;

  let waveform = [];

  for(let x=0; x<canvas.width; x+=3){
    let sumY = 0;
    let count = 0;

    for(let y=0; y<canvas.height; y++){
      let i = (y * canvas.width + x) * 4;
      let brightness = (data[i] + data[i+1] + data[i+2]) / 3;

      if(brightness > 200){ // WHITE waveform
        sumY += y;
        count++;
      }
    }

    if(count > 0){
      waveform.push(canvas.height - (sumY / count));
    }
  }

  // PEAK detection
  let peaks = [];
  for(let i=1;i<waveform.length-1;i++){
    if(
      waveform[i] > waveform[i-1] + 15 &&
      waveform[i] > waveform[i+1] + 15
    ){
      peaks.push(i);
    }
  }

  // BPM estimation
  let bpm = Math.min(200, Math.max(40, peaks.length * 4));

  document.getElementById("result").innerText =
    "Detected Beats: " + peaks.length + " | Estimated BPM: " + bpm;

  playHeartbeat(bpm);
}

function playHeartbeat(bpm){
  const ctxAudio = new (window.AudioContext || window.webkitAudioContext)();

  let interval = 60000 / bpm;

  let beat = setInterval(() => {
    const osc = ctxAudio.createOscillator();
    const gain = ctxAudio.createGain();

    osc.frequency.value = 150;
    gain.gain.value = 0.4;

    osc.connect(gain);
    gain.connect(ctxAudio.destination);

    osc.start();
    osc.stop(ctxAudio.currentTime + 0.1);
  }, interval);

  setTimeout(()=>clearInterval(beat), 4000);
}
</script>
  
</body>
</html>
