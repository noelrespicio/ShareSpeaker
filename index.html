<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Live ECG Camera Scan & Heartbeat Type Detection</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
  font-family:Arial,sans-serif;
  background:#f4f6f8;
  padding:20px;
}
.container{
  max-width:900px;
  margin:auto;
  background:#fff;
  padding:20px;
  border-radius:12px;
  box-shadow:0 4px 12px rgba(0,0,0,.15);
}
video, canvas{
  width:100%;
  border:1px solid #ddd;
  margin-top:10px;
}
button{
  width:100%;
  padding:10px;
  margin-top:10px;
  background:#2563eb;
  color:#fff;
  border:none;
  border-radius:8px;
  cursor:pointer;
}
.result{
  margin-top:15px;
  text-align:center;
  font-weight:bold;
}
.valid{color:green;}
.invalid{color:red;}
</style>
</head>

<body>
<div class="container">
  <h2>ðŸ“· Live ECG Camera Scan</h2>

  <video id="video" autoplay playsinline></video>
  <canvas id="frame"></canvas>
  <canvas id="wave"></canvas>

  <button onclick="startScan()">Start Live Scan</button>

  <div id="result" class="result"></div>
</div>

<script>
const video = document.getElementById("video");
const frame = document.getElementById("frame");
const fctx = frame.getContext("2d");

const wave = document.getElementById("wave");
const wctx = wave.getContext("2d");

let scanning=false;
let waveform=[];

// CAMERA
async function startScan(){
  const stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});
  video.srcObject = stream;
  scanning=true;
  setInterval(captureFrame,200);
}

// CAPTURE & ANALYZE FRAME
function captureFrame(){
  if(!scanning) return;

  frame.width = video.videoWidth;
  frame.height = video.videoHeight;
  fctx.drawImage(video,0,0);

  const img = fctx.getImageData(0,0,frame.width,frame.height);
  const d = img.data;

  // GRID + NOISE FILTER
  for(let i=0;i<d.length;i+=4){
    let b=(d[i]+d[i+1]+d[i+2])/3;
    if(b<120){ // remove grid & dark noise
      d[i]=d[i+1]=d[i+2]=255;
    }
  }

  // Extract waveform center
  let x = Math.floor(frame.width/2);
  let sumY=0,count=0;

  for(let y=0;y<frame.height;y++){
    let i=(y*frame.width+x)*4;
    let b=(d[i]+d[i+1]+d[i+2])/3;
    if(b>230){
      sumY+=y;
      count++;
    }
  }

  if(count>3){
    waveform.push(frame.height-(sumY/count));
    if(waveform.length>300) waveform.shift();
  }

  analyzeSignal();
  drawWave();
}

// ANALYSIS
function analyzeSignal(){
  if(waveform.length<60) return;

  let peaks=[];
  for(let i=3;i<waveform.length-3;i++){
    if(
      waveform[i]>waveform[i-1] &&
      waveform[i]>waveform[i+1] &&
      waveform[i]-waveform[i-3]>15
    ){
      peaks.push(i);
    }
  }

  if(peaks.length<4){
    show("âŒ No heartbeat detected",false);
    return;
  }

  // Assume 10 seconds buffer
  let bpm = Math.round((peaks.length/10)*60);

  let type="Unknown";
  if(bpm>=60 && bpm<=100) type="ðŸ‘¨ Adult Heartbeat";
  else if(bpm>100 && bpm<=160) type="ðŸ‘¨ Adult Tachycardia";
  else if(bpm>120 && bpm<=180) type="ðŸ‘¶ Fetal / Ultrasound-like";
  else{
    show("âŒ Not a valid heartbeat",false);
    return;
  }

  show(`âœ… ${type}<br>BPM: ${bpm}`,true);
}

// DRAW WAVEFORM
function drawWave(){
  wave.width=waveform.length;
  wave.height=200;
  wctx.clearRect(0,0,wave.width,wave.height);

  wctx.beginPath();
  wctx.strokeStyle="#2563eb";
  wctx.lineWidth=2;

  waveform.forEach((v,i)=>{
    let y=wave.height-(v/frame.height)*wave.height;
    if(i===0) wctx.moveTo(i,y);
    else wctx.lineTo(i,y);
  });
  wctx.stroke();
}

function show(msg,ok){
  const r=document.getElementById("result");
  r.innerHTML=msg;
  r.className="result "+(ok?"valid":"invalid");
}
</script>
</body>
</html>

