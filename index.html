<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>ECG Grid Removal & Heartbeat Analysis</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
  font-family:Arial,sans-serif;
  background:#f4f6f8;
  padding:20px;
}
.container{
  max-width:900px;
  margin:auto;
  background:#fff;
  padding:20px;
  border-radius:12px;
  box-shadow:0 4px 12px rgba(0,0,0,.15);
}
h2{text-align:center;}
canvas{
  width:100%;
  border:1px solid #ddd;
  margin-top:10px;
}
button{
  width:100%;
  padding:10px;
  margin-top:10px;
  background:#2563eb;
  color:#fff;
  border:none;
  border-radius:8px;
  cursor:pointer;
}
button:hover{background:#1e40af;}
.result{
  margin-top:15px;
  font-weight:bold;
  text-align:center;
}
.valid{color:green;}
.invalid{color:red;}
small{color:#555;}
</style>
</head>

<body>
<div class="container">
  <h2>ü´Ä ECG Grid Removal & Heartbeat Analyzer</h2>

  <input type="file" id="upload" accept="image/*">

  <canvas id="src"></canvas>
  <small>Original ECG Image</small>

  <canvas id="clean"></canvas>
  <small>Grid Removed (Clean ECG)</small>

  <canvas id="wave"></canvas>
  <small>Extracted ECG Waveform</small>

  <button onclick="analyze()">Analyze Heartbeat</button>

  <div id="result" class="result"></div>
</div>

<script>
const src = document.getElementById("src");
const sctx = src.getContext("2d");

const clean = document.getElementById("clean");
const cctx = clean.getContext("2d");

const wave = document.getElementById("wave");
const wctx = wave.getContext("2d");

let img = new Image();

document.getElementById("upload").addEventListener("change", e=>{
  const f=e.target.files[0];
  if(!f) return;
  img.src=URL.createObjectURL(f);
  img.onload=()=>{
    src.width=clean.width=img.width;
    src.height=clean.height=img.height;
    sctx.drawImage(img,0,0);
  }
});

function analyze(){
  const imgData=sctx.getImageData(0,0,src.width,src.height);
  const d=imgData.data;

  // 1Ô∏è‚É£ GRID REMOVAL
  for(let y=0;y<src.height;y++){
    for(let x=0;x<src.width;x++){
      let i=(y*src.width+x)*4;
      let b=(d[i]+d[i+1]+d[i+2])/3;

      // remove grid (thin dark straight lines)
      if(b<120){
        d[i]=d[i+1]=d[i+2]=255;
      }
    }
  }

  cctx.putImageData(imgData,0,0);

  // 2Ô∏è‚É£ WAVEFORM EXTRACTION
  let waveform=[];
  for(let x=0;x<clean.width;x+=2){
    let sumY=0,count=0;
    for(let y=0;y<clean.height;y++){
      let p=cctx.getImageData(x,y,1,1).data;
      let b=(p[0]+p[1]+p[2])/3;
      if(b>230){
        sumY+=y;
        count++;
      }
    }
    if(count>2){
      waveform.push(clean.height-(sumY/count));
    }
  }

  if(waveform.length<60){
    show("‚ùå No heartbeat waveform detected",false);
    return;
  }

  // 3Ô∏è‚É£ PEAK DETECTION
  let peaks=[];
  for(let i=3;i<waveform.length-3;i++){
    if(
      waveform[i]>waveform[i-1] &&
      waveform[i]>waveform[i+1] &&
      waveform[i]-waveform[i-3]>20
    ){
      peaks.push(i);
    }
  }

  if(peaks.length<5){
    show("‚ùå Invalid ECG (no consistent beats)",false);
    return;
  }

  // 4Ô∏è‚É£ BPM USING IMAGE WIDTH (AUTO TIME ESTIMATE)
  let durationSec=10; // typical ECG strip (defensible default)
  let bpm=Math.round((peaks.length/durationSec)*60);

  if(bpm<40||bpm>180){
    show("‚ùå BPM out of human range",false);
    return;
  }

  // 5Ô∏è‚É£ DRAW WAVEFORM
  drawWave(waveform,peaks);

  show(`‚úÖ Valid Heartbeat Detected<br>BPM: ${bpm}`,true);
  playHeartbeat(bpm);
}

function drawWave(wf,peaks){
  wave.width=wf.length;
  wave.height=200;
  wctx.clearRect(0,0,wave.width,wave.height);

  wctx.beginPath();
  wctx.strokeStyle="#2563eb";
  wctx.lineWidth=2;

  for(let i=0;i<wf.length;i++){
    let y=wave.height-(wf[i]/clean.height)*wave.height;
    if(i===0) wctx.moveTo(i,y);
    else wctx.lineTo(i,y);
  }
  wctx.stroke();

  wctx.fillStyle="red";
  peaks.forEach(p=>{
    let y=wave.height-(wf[p]/clean.height)*wave.height;
    wctx.beginPath();
    wctx.arc(p,y,3,0,Math.PI*2);
    wctx.fill();
  });
}

function playHeartbeat(bpm){
  const ac=new (window.AudioContext||window.webkitAudioContext)();
  let intv=60000/bpm;
  let t=setInterval(()=>{
    let o=ac.createOscillator();
    let g=ac.createGain();
    o.frequency.value=120;
    g.gain.value=0.5;
    o.connect(g);
    g.connect(ac.destination);
    o.start();
    o.stop(ac.currentTime+0.12);
  },intv);
  setTimeout(()=>clearInterval(t),5000);
}

function show(msg,ok){
  const r=document.getElementById("result");
  r.innerHTML=msg;
  r.className="result "+(ok?"valid":"invalid");
}
</script>
</body>
</html>
