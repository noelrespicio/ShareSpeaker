<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>ECG Image Analyzer (Legit)</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
  font-family:Arial, sans-serif;
  background:#f4f6f8;
  padding:20px;
}
.container{
  max-width:900px;
  margin:auto;
  background:#fff;
  padding:20px;
  border-radius:12px;
  box-shadow:0 4px 12px rgba(0,0,0,.15);
}
h2{text-align:center;}
canvas{
  width:100%;
  border:1px solid #ddd;
  margin-top:10px;
}
button{
  width:100%;
  padding:10px;
  margin-top:10px;
  background:#2563eb;
  color:#fff;
  border:none;
  border-radius:8px;
  cursor:pointer;
}
button:hover{background:#1e40af;}
.result{
  margin-top:15px;
  text-align:center;
  font-weight:bold;
}
.valid{color:green;}
.invalid{color:red;}
small{color:#555;}
</style>
</head>

<body>
<div class="container">
  <h2>ü´Ä Legit ECG Image Analyzer</h2>

  <input type="file" id="upload" accept="image/*">

  <canvas id="srcCanvas"></canvas>
  <small>Original ECG Image</small>

  <canvas id="waveCanvas"></canvas>
  <small>Extracted ECG Waveform</small>

  <button onclick="analyze()">Analyze ECG</button>

  <div class="result" id="result"></div>
</div>

<script>
const srcCanvas = document.getElementById("srcCanvas");
const srcCtx = srcCanvas.getContext("2d");

const waveCanvas = document.getElementById("waveCanvas");
const waveCtx = waveCanvas.getContext("2d");

let img = new Image();

// LOAD IMAGE
document.getElementById("upload").addEventListener("change", e=>{
  const file = e.target.files[0];
  if(!file) return;
  img.src = URL.createObjectURL(file);
  img.onload = ()=>{
    srcCanvas.width = img.width;
    srcCanvas.height = img.height;
    srcCtx.drawImage(img,0,0);
  };
});

// MAIN ANALYSIS
function analyze(){
  const imageData = srcCtx.getImageData(0,0,srcCanvas.width,srcCanvas.height);
  const data = imageData.data;

  // 1Ô∏è‚É£ AUTO GRID DETECTION (vertical lines)
  let xLines = [];
  for(let x=0;x<srcCanvas.width;x++){
    let darkCount = 0;
    for(let y=0;y<srcCanvas.height;y++){
      let i=(y*srcCanvas.width+x)*4;
      let b=(data[i]+data[i+1]+data[i+2])/3;
      if(b < 80) darkCount++;
    }
    if(darkCount > srcCanvas.height*0.6){
      xLines.push(x);
    }
  }

  if(xLines.length < 10){
    show("‚ùå ECG grid not detected", false);
    return;
  }

  // Calculate average grid spacing (pixels)
  let spacings=[];
  for(let i=1;i<xLines.length;i++){
    let d = xLines[i]-xLines[i-1];
    if(d>5 && d<80) spacings.push(d);
  }
  let avgGridPx = spacings.reduce((a,b)=>a+b,0)/spacings.length;

  // ECG paper: 1 small box = 1mm, 25mm/sec
  let mmPerSec = 25;
  let pxPerMm = avgGridPx;
  let pxPerSec = pxPerMm * mmPerSec;

  // 2Ô∏è‚É£ WAVEFORM EXTRACTION
  let waveform=[];
  for(let x=0;x<srcCanvas.width;x+=2){
    let sumY=0,count=0;
    for(let y=0;y<srcCanvas.height;y++){
      let i=(y*srcCanvas.width+x)*4;
      let b=(data[i]+data[i+1]+data[i+2])/3;
      if(b>200){ // white ECG trace
        sumY+=y;
        count++;
      }
    }
    if(count>3){
      waveform.push(srcCanvas.height-(sumY/count));
    }
  }

  if(waveform.length < 50){
    show("‚ùå ECG waveform not detected", false);
    return;
  }

  // 3Ô∏è‚É£ PEAK DETECTION
  let peaks=[];
  for(let i=3;i<waveform.length-3;i++){
    if(
      waveform[i] > waveform[i-1] &&
      waveform[i] > waveform[i+1] &&
      waveform[i] - waveform[i-3] > 20
    ){
      peaks.push(i);
    }
  }

  if(peaks.length < 5){
    show("‚ùå No valid heartbeat peaks", false);
    return;
  }

  // 4Ô∏è‚É£ BPM CALCULATION (LEGIT)
  let intervalsPx=[];
  for(let i=1;i<peaks.length;i++){
    intervalsPx.push(peaks[i]-peaks[i-1]);
  }

  let avgIntervalPx = intervalsPx.reduce((a,b)=>a+b)/intervalsPx.length;
  let secondsPerBeat = avgIntervalPx / pxPerSec;
  let bpm = Math.round(60 / secondsPerBeat);

  if(bpm<40 || bpm>180){
    show("‚ùå BPM out of human range", false);
    return;
  }

  // 5Ô∏è‚É£ DRAW EXTRACTED WAVEFORM
  drawWaveform(waveform, peaks);

  show(`‚úÖ Valid ECG Detected<br>
        BPM: ${bpm}<br>
        Estimated speed: ${mmPerSec} mm/sec`, true);

  playHeartbeat(bpm);
}

// DRAW WAVEFORM
function drawWaveform(wave, peaks){
  waveCanvas.width = wave.length;
  waveCanvas.height = 200;
  waveCtx.clearRect(0,0,waveCanvas.width,waveCanvas.height);

  waveCtx.beginPath();
  waveCtx.strokeStyle="#2563eb";
  waveCtx.lineWidth=2;

  for(let i=0;i<wave.length;i++){
    let y = waveCanvas.height - (wave[i]/srcCanvas.height)*waveCanvas.height;
    if(i===0) waveCtx.moveTo(i,y);
    else waveCtx.lineTo(i,y);
  }
  waveCtx.stroke();

  // Mark peaks
  waveCtx.fillStyle="red";
  peaks.forEach(p=>{
    let y = waveCanvas.height - (wave[p]/srcCanvas.height)*waveCanvas.height;
    waveCtx.beginPath();
    waveCtx.arc(p,y,3,0,Math.PI*2);
    waveCtx.fill();
  });
}

// SOUND
function playHeartbeat(bpm){
  const audioCtx = new (window.AudioContext||window.webkitAudioContext)();
  let interval = 60000/bpm;

  let beat = setInterval(()=>{
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.frequency.value=120;
    gain.gain.value=0.5;
    osc.connect(gain);
    gain.connect(audioCtx.destination);
    osc.start();
    osc.stop(audioCtx.currentTime+0.12);
  },interval);

  setTimeout(()=>clearInterval(beat),5000);
}

// RESULT
function show(msg, ok){
  const r=document.getElementById("result");
  r.innerHTML=msg;
  r.className="result "+(ok?"valid":"invalid");
}
</script>
</body>
</html>
